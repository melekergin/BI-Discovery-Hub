<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BI Discovery</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg: #0d0f12;
    --surface: #141720;
    --surface2: #1c2030;
    --border: #252a3a;
    --accent: #4f8ef7;
    --accent2: #7c5cbf;
    --green: #3dd68c;
    --yellow: #f5c842;
    --red: #f06060;
    --text: #e2e8f0;
    --muted: #64748b;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-weight: 300;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    border-bottom: 1px solid var(--border);
    padding: 18px 32px;
    display: flex;
    align-items: center;
    gap: 16px;
    background: var(--surface);
  }

  .logo {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--accent);
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  .logo span { color: var(--muted); }

  .tag {
    font-family: var(--mono);
    font-size: 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 3px 8px;
    border-radius: 3px;
    letter-spacing: 0.1em;
  }

  main {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    height: calc(100vh - 57px);
  }

  .panel {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    overflow: hidden;
  }

  .panel-header {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface);
  }

  .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
  }

  .panel-body {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .field-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  label {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  select, textarea {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--sans);
    font-size: 14px;
    border-radius: 6px;
    outline: none;
    transition: border-color 0.15s;
    width: 100%;
  }

  select:focus, textarea:focus {
    border-color: var(--accent);
  }

  select {
    padding: 10px 14px;
    cursor: pointer;
  }

  select option { background: var(--surface2); }

  textarea {
    padding: 14px;
    font-family: var(--mono);
    font-size: 12px;
    line-height: 1.7;
    resize: none;
    flex: 1;
    min-height: 300px;
  }

  .context-input {
    padding: 10px 14px;
    font-size: 13px;
    min-height: unset;
    font-family: var(--sans);
    resize: none;
    height: 60px;
  }

  .actions {
    display: flex;
    gap: 10px;
  }

  button {
    font-family: var(--mono);
    font-size: 12px;
    letter-spacing: 0.08em;
    border: none;
    border-radius: 6px;
    padding: 11px 20px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
    flex: 1;
  }

  .btn-primary:hover { background: #6fa0ff; }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-clear {
    background: var(--surface2);
    color: var(--muted);
    border: 1px solid var(--border);
  }

  .btn-clear:hover { color: var(--text); border-color: var(--muted); }

  /* Output panel */
  .output-panel {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .output-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: var(--muted);
  }

  .empty-icon {
    font-size: 40px;
    opacity: 0.3;
  }

  .empty-state p {
    font-family: var(--mono);
    font-size: 12px;
    letter-spacing: 0.1em;
  }

  /* Result blocks */
  .result-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .result-block-header {
    padding: 10px 16px;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  .result-block-header .icon { font-size: 14px; }

  .result-block-body {
    padding: 16px;
    font-size: 14px;
    line-height: 1.7;
    color: var(--text);
  }

  .result-block-body p { margin-bottom: 8px; }
  .result-block-body p:last-child { margin-bottom: 0; }

  .badge {
    display: inline-block;
    font-family: var(--mono);
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 3px;
    margin-right: 4px;
    margin-bottom: 2px;
  }

  .badge-blue { background: rgba(79,142,247,0.15); color: var(--accent); border: 1px solid rgba(79,142,247,0.3); }
  .badge-green { background: rgba(61,214,140,0.12); color: var(--green); border: 1px solid rgba(61,214,140,0.3); }
  .badge-yellow { background: rgba(245,200,66,0.12); color: var(--yellow); border: 1px solid rgba(245,200,66,0.3); }
  .badge-red { background: rgba(240,96,96,0.12); color: var(--red); border: 1px solid rgba(240,96,96,0.3); }

  .kv-grid {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: 8px 16px;
    font-size: 13px;
  }

  .kv-key {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    padding-top: 2px;
  }

  .kv-val { color: var(--text); line-height: 1.5; }

  .table-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 4px;
  }

  .question-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .question-item {
    display: flex;
    gap: 10px;
    padding: 10px 12px;
    background: var(--surface2);
    border-radius: 6px;
    border-left: 3px solid var(--yellow);
    font-size: 13px;
    line-height: 1.5;
  }

  .q-num {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--yellow);
    min-width: 20px;
    padding-top: 1px;
  }

  .assumption-tag {
    display: inline-block;
    font-family: var(--mono);
    font-size: 10px;
    color: var(--yellow);
    background: rgba(245,200,66,0.1);
    border: 1px solid rgba(245,200,66,0.25);
    padding: 1px 6px;
    border-radius: 3px;
    margin-left: 6px;
    vertical-align: middle;
  }

  .open-tag {
    display: inline-block;
    font-family: var(--mono);
    font-size: 10px;
    color: var(--red);
    background: rgba(240,96,96,0.1);
    border: 1px solid rgba(240,96,96,0.25);
    padding: 1px 6px;
    border-radius: 3px;
    margin-left: 6px;
    vertical-align: middle;
  }

  /* Loading */
  .loading-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 40px;
    color: var(--muted);
  }

  .spinner {
    width: 28px; height: 28px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-wrap p {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 0.1em;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }

  /* Export bar */
  .export-bar {
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .btn-export {
    background: var(--surface2);
    color: var(--muted);
    border: 1px solid var(--border);
    font-size: 11px;
    padding: 7px 14px;
  }

  .btn-export:hover { color: var(--text); border-color: var(--accent); }

  .export-label {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.1em;
    margin-right: auto;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  .error-msg {
    background: rgba(240,96,96,0.1);
    border: 1px solid rgba(240,96,96,0.3);
    color: var(--red);
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 13px;
    font-family: var(--mono);
  }
</style>
</head>
<body>

<header>
  <div class="logo">BI <span>//</span> Discovery</div>
  <div class="tag">Krankenhaus · MSBI Analyse</div>
</header>

<main>
  <!-- INPUT PANEL -->
  <div class="panel">
    <div class="panel-header">
      <div class="dot"></div>
      Eingabe
    </div>
    <div class="panel-body">

      <div class="field-group">
        <label>Fachbereich</label>
        <select id="bereich">
          <option value="">— Bereich wählen —</option>
          <option value="Medizintechnik">Medizintechnik</option>
          <option value="Klinische Dienste">Klinische Dienste</option>
          <option value="Infrastruktur">Infrastruktur</option>
          <option value="Finanzen / Buchhaltung">Finanzen / Buchhaltung</option>
          <option value="Einkauf">Einkauf</option>
          <option value="Personal / HR">Personal / HR</option>
          <option value="Medizinischer Dienst">Medizinischer Dienst</option>
          <option value="AEMP">AEMP</option>
          <option value="Unbekannt">Unbekannt</option>
        </select>
      </div>

      <div class="field-group">
        <label>Kontext (optional)</label>
        <textarea id="kontext" class="context-input" placeholder="z.B. View aus SSAS Cube, wird im Controlling-Report verwendet..."></textarea>
      </div>

      <div class="field-group" style="flex:1; display:flex; flex-direction:column;">
        <label>SQL / View / Stored Procedure</label>
        <textarea id="sqlInput" placeholder="SELECT ...&#10;FROM ...&#10;&#10;Einfach hier einfügen."></textarea>
      </div>

      <div class="actions">
        <button class="btn-primary" id="analyzeBtn" onclick="analyze()">Analysieren →</button>
        <button class="btn-clear" onclick="clearAll()">Leeren</button>
      </div>

    </div>
  </div>

  <!-- OUTPUT PANEL -->
  <div class="output-panel">
    <div class="panel-header">
      <div class="dot" style="background:var(--green)"></div>
      Analyse
    </div>

    <div class="output-body" id="outputBody">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">⬡</div>
        <p>Warte auf SQL-Eingabe</p>
      </div>
    </div>

    <div class="export-bar" id="exportBar" style="display:none">
      <span class="export-label">Export</span>
      <button class="btn-export" onclick="exportMarkdown()">↓ Markdown</button>
      <button class="btn-export" onclick="copyAll()">⎘ Kopieren</button>
    </div>
  </div>
</main>

<script>
let lastResult = null;

async function analyze() {
  const sql = document.getElementById('sqlInput').value.trim();
  const bereich = document.getElementById('bereich').value;
  const kontext = document.getElementById('kontext').value.trim();

  if (!sql) {
    alert('Bitte SQL einfügen.');
    return;
  }

  const btn = document.getElementById('analyzeBtn');
  btn.disabled = true;
  btn.textContent = 'Analysiere...';

  const outputBody = document.getElementById('outputBody');
  outputBody.innerHTML = `
    <div class="loading-wrap">
      <div class="spinner"></div>
      <p>Logik wird rekonstruiert...</p>
    </div>
  `;
  document.getElementById('exportBar').style.display = 'none';

  const prompt = `Du bist Senior BI-Analyst in einem Krankenhaus (Deutschland).
Aufgabe: Analysiere den folgenden SQL-Code und erkläre ihn strukturiert auf Deutsch.
Regeln: Keine Halluzinationen. Annahmen immer mit [ANNAHME] markieren. Unklares mit [OFFEN] markieren. Keine Theorie, nur was im Code steht.

BEREICH: ${bereich || 'Unbekannt'}
${kontext ? `KONTEXT: ${kontext}` : ''}

SQL:
${sql}

Antworte NUR als valides JSON-Objekt mit dieser exakten Struktur (kein Markdown, kein Text davor/danach):
{
  "was_berechnet": "2-3 Sätze, was dieser Code tatsächlich tut. Einfache Sprache.",
  "grain": "Was ist eine Zeile im Ergebnis?",
  "tabellen": ["tabelle1", "tabelle2"],
  "filter": "Welche Datensätze werden ausgeschlossen oder gefiltert?",
  "business_definition": "Die Kennzahl / Abfrage liefert X wenn Y...",
  "fachlicher_kontext": "Was bedeutet das im Krankenhaus-Alltag? Wer nutzt das wahrscheinlich?",
  "offene_fragen": ["Frage 1 an den Fachbereich", "Frage 2", "Frage 3"],
  "qualitaet": "kurze Einschätzung: gibt es potenzielle Probleme im Code (Duplikate, fehlende Filter, etc.)?"
}`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    const data = await response.json();
    const text = data.content?.[0]?.text || '';

    // Parse JSON - strip possible markdown fences
    const clean = text.replace(/```json|```/g, '').trim();
    const result = JSON.parse(clean);
    lastResult = { bereich, sql, kontext, result };
    renderResult(result, bereich);

  } catch(e) {
    outputBody.innerHTML = `<div class="error-msg">Fehler beim Analysieren: ${e.message}<br><br>Bitte prüfe ob der API-Zugang verfügbar ist.</div>`;
  }

  btn.disabled = false;
  btn.textContent = 'Analysieren →';
}

function renderResult(r, bereich) {
  const outputBody = document.getElementById('outputBody');

  const tabellen = (r.tabellen || []).map(t =>
    `<span class="badge badge-blue">${t}</span>`
  ).join('');

  const fragen = (r.offene_fragen || []).map((q, i) =>
    `<div class="question-item"><span class="q-num">Q${i+1}</span><span>${formatText(q)}</span></div>`
  ).join('');

  outputBody.innerHTML = `
    <div class="result-block">
      <div class="result-block-header">
        <span class="icon">◈</span> WAS BERECHNET DIESER CODE
      </div>
      <div class="result-block-body">
        <p>${formatText(r.was_berechnet)}</p>
      </div>
    </div>

    <div class="result-block">
      <div class="result-block-header">
        <span class="icon">◎</span> GRAIN · KARDINALITÄT
      </div>
      <div class="result-block-body">
        <div class="kv-grid">
          <div class="kv-key">Eine Zeile ist</div>
          <div class="kv-val">${formatText(r.grain)}</div>
          <div class="kv-key">Tabellen</div>
          <div class="kv-val"><div class="table-list">${tabellen || '—'}</div></div>
          <div class="kv-key">Filter</div>
          <div class="kv-val">${formatText(r.filter || '—')}</div>
        </div>
      </div>
    </div>

    <div class="result-block">
      <div class="result-block-header">
        <span class="icon">◇</span> BUSINESS DEFINITION
      </div>
      <div class="result-block-body">
        <p style="font-style:italic; color: #a5c4fc;">${formatText(r.business_definition)}</p>
        <p style="margin-top:12px; color: var(--muted); font-size:13px;">${formatText(r.fachlicher_kontext)}</p>
      </div>
    </div>

    ${r.qualitaet ? `
    <div class="result-block">
      <div class="result-block-header">
        <span class="icon">⚠</span> QUALITÄT · POTENZIELLE PROBLEME
      </div>
      <div class="result-block-body">
        <p>${formatText(r.qualitaet)}</p>
      </div>
    </div>` : ''}

    <div class="result-block">
      <div class="result-block-header">
        <span class="icon">?</span> FRAGEN AN DEN FACHBEREICH
      </div>
      <div class="result-block-body">
        <div class="question-list">${fragen || '—'}</div>
      </div>
    </div>
  `;

  document.getElementById('exportBar').style.display = 'flex';
}

function formatText(text) {
  if (!text) return '';
  return text
    .replace(/\[ANNAHME\]/g, '<span class="assumption-tag">ANNAHME</span>')
    .replace(/\[OFFEN\]/g, '<span class="open-tag">OFFEN</span>');
}

function clearAll() {
  document.getElementById('sqlInput').value = '';
  document.getElementById('kontext').value = '';
  document.getElementById('bereich').value = '';
  document.getElementById('outputBody').innerHTML = `
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">⬡</div>
      <p>Warte auf SQL-Eingabe</p>
    </div>`;
  document.getElementById('exportBar').style.display = 'none';
  lastResult = null;
}

function exportMarkdown() {
  if (!lastResult) return;
  const r = lastResult.result;
  const date = new Date().toISOString().split('T')[0];
  const md = `# BI Discovery – ${lastResult.bereich || 'Unbekannt'}
_Analysiert: ${date}_

## Was berechnet dieser Code
${r.was_berechnet}

## Grain
${r.grain}

## Tabellen
${(r.tabellen || []).map(t => `- \`${t}\``).join('\n')}

## Filter / Ausschlüsse
${r.filter || '—'}

## Business Definition
> ${r.business_definition}

${r.fachlicher_kontext}

## Qualität
${r.qualitaet || '—'}

## Fragen an den Fachbereich
${(r.offene_fragen || []).map((q, i) => `${i+1}. ${q}`).join('\n')}

---
\`\`\`sql
${lastResult.sql}
\`\`\`
`;

  const blob = new Blob([md], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `bi-discovery-${(lastResult.bereich || 'analyse').toLowerCase().replace(/\s/g,'-')}-${date}.md`;
  a.click();
}

function copyAll() {
  if (!lastResult) return;
  const r = lastResult.result;
  const text = [
    `Bereich: ${lastResult.bereich}`,
    `\nWas: ${r.was_berechnet}`,
    `\nGrain: ${r.grain}`,
    `\nTabellen: ${(r.tabellen||[]).join(', ')}`,
    `\nBusiness Definition: ${r.business_definition}`,
    `\nQualität: ${r.qualitaet}`,
    `\nFragen:\n${(r.offene_fragen||[]).map((q,i)=>`${i+1}. ${q}`).join('\n')}`
  ].join('\n');
  navigator.clipboard.writeText(text);
}
</script>
</body>
</html>
